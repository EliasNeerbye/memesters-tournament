<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests | Meemesters API</title>
</head>
<body>
    <label for="registerEmail">Email: <input type="email" name="email" id="registerEmail"></label><br>
    <label for="registerUsername">Username: <input type="text" name="username" id="registerUsername"></label><br>
    <label for="registerCode">Code: <input type="number" name="code" id="registerCode"></label><br>
    <button onclick="testRegister()">Get Register Code</button><hr><button onclick="testRegister(true)">Register User</button>
    <br><br><br>
    <label for="loginEmailOrUsername">Email or Username: <input type="text" name="emailOrUsername" id="loginEmailOrUsername"></label><br>
    <label for="loginCode">Code: <input type="number" name="code" id="loginCode"></label><br>
    <button onclick="testLogin()">Get Login Code</button><hr><button onclick="testLogin(true)">Login</button>
    <br><br><br>
    <label for="deleteCode">Code: <input type="number" name="code" id="deleteCode"></label><br>
    <button onclick="testDelete()">Get Deletion Code</button><hr><button onclick="testDelete(true)">Delete user</button>
    <br><br>
    <div id="errorField"></div>
    <div id="tokenField"></div>

    <script>
    let jwtToken = '';

    async function testRegister(withCode = false) {
        const email = document.getElementById('registerEmail').value;
        const username = document.getElementById('registerUsername').value;
        const code = document.getElementById('registerCode').value;
        
        let url = '/api/users/register';
        let body = { email, username };
        
        if (withCode) {
            url += '/code';
            body.code = code;
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            });
            
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function testLogin(withCode = false) {
        const emailOrUsername = document.getElementById('loginEmailOrUsername').value;
        const code = document.getElementById('loginCode').value;
        
        let url = '/api/users/login';
        let body = { emailOrUsername };
        
        if (withCode) {
            url += '/code';
            body.code = code;
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            });
            
            const data = await response.json();
            if (response.ok && data.token) {
                jwtToken = data.token;
                localStorage.setItem('jwtToken', jwtToken);
                document.getElementById('tokenField').textContent = `Token: ${jwtToken}`;
            }
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function testDelete(withCode = false) {
        const code = document.getElementById('deleteCode').value;
        
        let url = '/api/users/delete-user';
        let body = {};
        
        if (withCode) {
            url += '/code';
            body.code = code;
        }
        
        try {
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify(body),
            });
            
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    function displayResult(data, status) {
        const errorField = document.getElementById('errorField');
        errorField.innerHTML = `Status: ${status}<br>Message: ${data.message || 'No message provided'}`;
    }

    // Load token from localStorage on page load
    window.onload = function() {
        jwtToken = localStorage.getItem('jwtToken') || '';
        if (jwtToken) {
            document.getElementById('tokenField').textContent = `Token: ${jwtToken}`;
        }
    }
    </script>
</body>
</html>