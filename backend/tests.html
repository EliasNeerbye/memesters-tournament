<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests | Meemesters API</title>
</head>
<body>
    <h2>Login</h2>
    <label for="loginEmailOrUsername">Email or Username: <input type="text" name="emailOrUsername" id="loginEmailOrUsername"></label><br>
    <label for="loginCode">Code: <input type="number" name="code" id="loginCode"></label><br>
    <button onclick="testLogin()">Get Login Code</button><hr><button onclick="testLogin(true)">Login</button>

    <h2>Profile</h2>
    <button onclick="getProfile()">Get Profile</button>

    <h2>Update Username</h2>
    <label for="newUsername">New Username: <input type="text" id="newUsername"></label><br>
    <button onclick="updateUsername()">Update Username</button>

    <h2>Update Email</h2>
    <button onclick="requestEmailChange()">Request Email Change</button><br>
    <label for="emailChangeCode">Verification Code: <input type="text" id="emailChangeCode"></label><br>
    <label for="newEmail">New Email: <input type="email" id="newEmail"></label><br>
    <button onclick="updateEmail()">Update Email</button>

    <h2>Verify New Email</h2>
    <label for="newEmailCode">New Email Verification Code: <input type="text" id="newEmailCode"></label><br>
    <button onclick="verifyNewEmail()">Verify New Email</button>

    <h2>Update Profile Picture</h2>
    <input type="file" id="pfpInput" accept="image/*"><br>
    <button onclick="updateProfilePicture()">Update Profile Picture</button>

    <h2>Logout</h2>
    <button onclick="logoutProfile()">Logout</button>

    <br><br>
    <div id="errorField"></div>
    <div id="tokenField"></div>

    <script>
    let jwtToken = '';

    async function testLogin(withCode = false) {
        const emailOrUsername = document.getElementById('loginEmailOrUsername').value;
        const code = document.getElementById('loginCode').value;
        
        let url = '/api/users/login';
        let body = { emailOrUsername };
        
        if (withCode) {
            url += '/code';
            body.code = code;
        }
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            });
            
            const data = await response.json();
            if (response.ok && data.token) {
                jwtToken = data.token;
                localStorage.setItem('jwtToken', jwtToken);
                document.getElementById('tokenField').textContent = `Token: ${jwtToken}`;
            }
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function getProfile() {
        try {
            const response = await fetch('/api/users/profile', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function updateUsername() {
        const username = document.getElementById('newUsername').value;
        try {
            const response = await fetch('/api/users/profile/username', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ username })
            });
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function requestEmailChange() {
        try {
            const response = await fetch('/api/users/profile/email', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function updateEmail() {
        const code = document.getElementById('emailChangeCode').value;
        const newEmail = document.getElementById('newEmail').value;
        try {
            const response = await fetch('/api/users/profile/email', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ code, newEmail })
            });
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function verifyNewEmail() {
        const newCode = document.getElementById('newEmailCode').value;
        try {
            const response = await fetch('/api/users/profile/email/code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify({ newCode })
            });
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    async function updateProfilePicture() {
        const fileInput = document.getElementById('pfpInput');
        const file = fileInput.files[0];
        if (!file) {
            displayResult({ message: 'No file selected' }, 400);
            return;
        }

        const formData = new FormData();
        formData.append('pfp', file);

        try {
            const response = await fetch('/api/users/profile/pfp', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: formData
            });
            const data = await response.json();
            displayResult(data, response.status);
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    function displayResult(data, status) {
        const errorField = document.getElementById('errorField');
        errorField.innerHTML = `Status: ${status}<br>Message: ${data.message || 'No message provided'}`;
        if (data.user) {
            errorField.innerHTML += '<br>User: ' + JSON.stringify(data.user);
        }
        if (data.pfpUrl) {
            errorField.innerHTML += `<br>New Profile Picture URL: ${data.pfpUrl}`;
        }
    }

    async function logoutProfile() {
        try {
            const response = await fetch('/api/users/logout', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${jwtToken}`
                }
            });
            const data = await response.json();
            displayResult(data, response.status);
            if (response.status == 200 || response.status == "200") {
                localStorage.removeItem('jwtToken');
            }
        } catch (error) {
            displayResult({ message: 'An error occurred' }, 500);
        }
    }

    // Load token from localStorage on page load
    window.onload = function() {
        jwtToken = localStorage.getItem('jwtToken') || '';
        if (jwtToken) {
            document.getElementById('tokenField').textContent = `Token: ${jwtToken}`;
        }
    }
    </script>
</body>
</html>