<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tests | Meemesters API</title>
</head>
<body>
    <h1>Meemesters API Test</h1>
    
    <div>
        <h2>Registration</h2>
        <input type="email" id="registerEmail" placeholder="Email">
        <button onclick="requestRegisterCode()">Request Register Code</button>
        <br><br>
        <input type="text" id="registerUsername" placeholder="Username">
        <input type="text" id="registerCode" placeholder="Enter Register Code">
        <button onclick="completeRegistration()">Complete Registration</button>
    </div>

    <div>
        <h2>Login</h2>
        <input type="text" id="emailOrUsername" placeholder="Email or Username">
        <button onclick="requestLoginCode()">Request Login Code</button>
        <br><br>
        <input type="text" id="loginCode" placeholder="Enter Login Code">
        <button onclick="verifyLoginCode()">Verify Code</button>
    </div>

    <div>
        <h2>User Profile</h2>
        <button onclick="getProfile()">Get Profile</button>
        <br><br>
        <input type="text" id="newUsername" placeholder="New Username">
        <button onclick="updateUsername()">Update Username</button>
        <br><br>
        <button onclick="initiateEmailChange()">Initiate Email Change</button>
        <br><br>
        <input type="text" id="emailChangeCode" placeholder="Email Change Code">
        <input type="email" id="newEmail" placeholder="New Email">
        <button onclick="updateEmail()">Update Email</button>
        <br><br>
        <input type="text" id="confirmNewEmailCode" placeholder="Confirm New Email Code">
        <button onclick="confirmNewEmail()">Confirm New Email</button>
        <br><br>
        <input type="file" id="pfpFile" accept="image/*">
        <button onclick="updateProfilePicture()">Update Profile Picture</button>
    </div>

    <div>
        <h2>Account Deletion</h2>
        <button onclick="initiateAccountDeletion()">Initiate Account Deletion</button>
        <br><br>
        <input type="text" id="deleteAccountCode" placeholder="Delete Account Code">
        <button onclick="confirmAccountDeletion()">Confirm Account Deletion</button>
    </div>

    <div>
        <h2>Logout</h2>
        <button onclick="logout()">Logout</button>
    </div>

    <div>
        <h2>Events Log</h2>
        <pre id="eventLog"></pre>
    </div>

    <script>
        function log(message) {
            const logElement = document.getElementById('eventLog');
            logElement.textContent += message + '\n';
        }

        async function makeRequest(url, method, body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include', // This ensures cookies are sent with the request
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(url, options);
            const data = await response.json();
            log(`${method} ${url}: ${JSON.stringify(data)}`);
            return data;
        }

        async function requestRegisterCode() {
            const email = document.getElementById('registerEmail').value;
            await makeRequest('/api/users/register', 'POST', { email });
        }

        async function completeRegistration() {
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const code = document.getElementById('registerCode').value;
            await makeRequest('/api/users/register/code', 'POST', { email, username, code });
        }

        async function requestLoginCode() {
            const emailOrUsername = document.getElementById('emailOrUsername').value;
            await makeRequest('/api/users/login', 'POST', { emailOrUsername });
        }

        async function verifyLoginCode() {
            const emailOrUsername = document.getElementById('emailOrUsername').value;
            const code = document.getElementById('loginCode').value;
            await makeRequest('/api/users/login/code', 'POST', { emailOrUsername, code });
        }

        async function getProfile() {
            await makeRequest('/api/users/profile', 'GET');
        }

        async function updateUsername() {
            const username = document.getElementById('newUsername').value;
            await makeRequest('/api/users/profile/username', 'PUT', { username });
        }

        async function initiateEmailChange() {
            await makeRequest('/api/users/profile/email', 'POST');
        }

        async function updateEmail() {
            const code = document.getElementById('emailChangeCode').value;
            const newEmail = document.getElementById('newEmail').value;
            await makeRequest('/api/users/profile/email', 'PUT', { code, newEmail });
        }

        async function confirmNewEmail() {
            const newCode = document.getElementById('confirmNewEmailCode').value;
            await makeRequest('/api/users/profile/email/code', 'POST', { newCode });
        }

        async function updateProfilePicture() {
            const fileInput = document.getElementById('pfpFile');
            const formData = new FormData();
            formData.append('pfp', fileInput.files[0]);
            const response = await fetch('/api/users/profile/pfp', {
                method: 'PUT',
                body: formData,
                credentials: 'include',
            });
            const data = await response.json();
            log(`PUT /api/users/profile/pfp: ${JSON.stringify(data)}`);
        }

        async function initiateAccountDeletion() {
            await makeRequest('/api/users/delete-user', 'DELETE');
        }

        async function confirmAccountDeletion() {
            const code = document.getElementById('deleteAccountCode').value;
            await makeRequest('/api/users/delete-user/code', 'DELETE', { code });
        }

        async function logout() {
            await makeRequest('/api/users/logout', 'GET');
        }
    </script>
</body>
</html>