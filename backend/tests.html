<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memesters Game Socket Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      input,
      button {
        margin: 5px;
        padding: 5px;
      }
      #eventLog {
        background-color: #f4f4f4;
        border: 1px solid #ddd;
        padding: 10px;
        max-height: 300px;
        overflow-y: scroll;
      }
      .section {
        margin-bottom: 20px;
      }
      #playerList {
        border: 1px solid #ddd;
        padding: 10px;
        margin-top: 10px;
      }
      .player-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 5px 0;
        padding: 5px;
        background-color: #f9f9f9;
      }
      .remove-player-btn {
        color: red;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Meemesters Game Socket Test</h1>

    <div id="authSection" style="display: none">
      <div class="section">
        <h2>User Login</h2>
        <input
          type="text"
          id="loginEmailOrUsername"
          placeholder="Email or Username"
        />
        <button onclick="initiateLogin()">Send Login Code</button>
        <br />
        <input type="text" id="loginCode" placeholder="Enter Login Code" />
        <button onclick="verifyLoginCode()">Verify Login</button>
      </div>

      <div class="section">
        <h2>User Registration</h2>
        <input type="email" id="email" placeholder="Enter Email" />
        <button onclick="registerEmail()">Register Email</button>
        <br />
        <input type="text" id="username" placeholder="Enter Username" />
        <input
          type="text"
          id="verificationCode"
          placeholder="Enter Verification Code"
        />
        <button onclick="verifyCode()">Verify Code</button>
      </div>
    </div>

    <div id="gameSection" style="display: none">
      <div class="section">
        <h2>Game Actions</h2>
        <button onclick="createGame()" id="createGameBtn">
          Create New Game
        </button>
        <br />
        <input type="text" id="gameCode" placeholder="Enter Game Code" />
        <button onclick="joinGame()" id="joinGameBtn">Join Game</button>
        <br /><br />
        <button onclick="finishGame()" id="finishGameBtn" disabled>
          Finish Game
        </button>
        <button onclick="leaveGame()" id="leaveGameBtn" disabled>
          Leave Game
        </button>
        <button onclick="rejoinGame()" id="rejoinGameBtn">Rejoin Game</button>
      </div>

      <div class="section" id="lobbySection" style="display: none">
        <h2>Lobby</h2>
        <div id="playerList"></div>
      </div>
    </div>

    <div>
      <h2>Events Log</h2>
      <pre id="eventLog"></pre>
    </div>

    <script>
      const socket = io({
        transports: ["websocket"],
      });
      let currentGameId = null;
      let isLoggedIn = false;
      let isHost = false;
      let currentPlayerId = null;

      // Check login status when page loads
      window.onload = checkLoginStatus;

      async function checkLoginStatus() {
        try {
          const response = await fetch("/api/users/isLoggedIn");
          if (response.status === 201) {
            isLoggedIn = true;
            showGameSection();
          } else {
            showAuthSection();
          }
        } catch (error) {
          log(`Error checking login status: ${error.message}`);
          showAuthSection();
        }
      }

      function showAuthSection() {
        document.getElementById("authSection").style.display = "block";
        document.getElementById("gameSection").style.display = "none";
      }

      function showGameSection() {
        document.getElementById("authSection").style.display = "none";
        document.getElementById("gameSection").style.display = "block";
      }

      function log(message) {
        const logElement = document.getElementById("eventLog");
        const timestamp = new Date().toLocaleTimeString();
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
      }

      // Login Functions
      async function initiateLogin() {
        const emailOrUsername = document.getElementById(
          "loginEmailOrUsername"
        ).value;
        if (!emailOrUsername) {
          log("Error: Please enter email or username");
          return;
        }
        try {
          const response = await fetch("/api/users/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ emailOrUsername }),
          });
          const data = await response.json();
          log(data.message);
        } catch (error) {
          log(`Login Error: ${error.message}`);
        }
      }

      // Update verifyLoginCode function
      async function verifyLoginCode() {
        const emailOrUsername = document.getElementById(
          "loginEmailOrUsername"
        ).value;
        const code = document.getElementById("loginCode").value;
        if (!emailOrUsername || !code) {
          log("Error: Please fill in all fields");
          return;
        }
        try {
          const response = await fetch("/api/users/login/code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ emailOrUsername, code }),
          });
          const data = await response.json();
          log(data.message);

          if (response.ok) {
            isLoggedIn = true;
            showGameSection();
          }
        } catch (error) {
          log(`Login Verification Error: ${error.message}`);
        }
      }

      // Update verifyCode function
      async function verifyCode() {
        const email = document.getElementById("email").value;
        const username = document.getElementById("username").value;
        const code = document.getElementById("verificationCode").value;
        if (!email || !username || !code) {
          log("Error: Please fill in all fields");
          return;
        }
        try {
          const response = await fetch("/api/users/register/code", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, username, code }),
          });
          const data = await response.json();
          log(data.message);

          if (response.ok) {
            isLoggedIn = true;
            showGameSection();
          }
        } catch (error) {
          log(`Verification Error: ${error.message}`);
        }
      }

      // User Registration Functions
      async function registerEmail() {
        const email = document.getElementById("email").value;
        if (!email) {
          log("Error: Please enter an email");
          return;
        }
        try {
          const response = await fetch("/api/users/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });
          const data = await response.json();
          log(data.message);
        } catch (error) {
          log(`Registration Error: ${error.message}`);
        }
      }

      // Lobby Management
      function updatePlayerList(players) {
        const playerListElement = document.getElementById("playerList");
        const lobbySection = document.getElementById("lobbySection");

        // Clear existing list
        playerListElement.innerHTML = "";

        // If no players, hide lobby section
        if (!players || players.length === 0) {
          lobbySection.style.display = "none";
          return;
        }

        // Show lobby section
        lobbySection.style.display = "block";

        // Populate player list
        players.forEach((player) => {
          const playerItem = document.createElement("div");
          playerItem.classList.add("player-item");

          // Player name
          const playerName = document.createElement("span");
          playerName.textContent =
            player.playerName || player.username || player.id;
          playerItem.appendChild(playerName);

          // Remove player button (only show for host)
          if (isHost && player.id !== currentPlayerId) {
            const removeBtn = document.createElement("button");
            removeBtn.textContent = "Remove";
            removeBtn.classList.add("remove-player-btn");
            removeBtn.onclick = () => removePlayer(player.id);
            playerItem.appendChild(removeBtn);
          }

          playerListElement.appendChild(playerItem);
        });
      }

      function removePlayer(playerId) {
        if (!isHost) {
          log("Error: Only the host can remove players");
          return;
        }
        socket.emit("removeUser", playerId);
      }

      // Socket connection events
      socket.on("connect", () => {
        log("Socket connected successfully");
      });

      socket.on("connect_error", (error) => {
        log(`Connection Error: ${error.message}`);
      });

      // Game-related event listeners
      socket.on("gameCreated", (data) => {
        log(
          `Game Created: ID ${data.gameId}, Host ID ${data.hostInfo.playerId}, Host Name: ${data.hostInfo.playerName}, Code ${data.code}`
        );
        currentGameId = data.gameId;
        currentPlayerId = data.hostInfo.playerId;
        isHost = true;
        enableGameActions();
        document.getElementById("lobbySection").style.display = "block";
        updatePlayerList([
          {
            id: data.hostInfo.playerId,
            playerName: data.hostInfo.playerName,
          },
        ]);
      });

      socket.on("gameJoined", (data) => {
        log(
          `Joined Game: ID ${data.gameId}, Player ID ${data.playerInfo.playerId}`
        );
        currentGameId = data.gameId;
        currentPlayerId = data.playerInfo.playerId;
        enableGameActions();
      });

      socket.on("newPlayerJoined", (data) => {
        log(`New Player Joined: ID ${data.playerId}`);
        // Request updated player list
        socket.emit("getPlayerList", currentGameId);
      });

      socket.on("playerList", (data) => {
        log("Received player list");
        updatePlayerList(data.players);
      });

      socket.on("playerRemoved", (data) => {
        log(`Player Removed: ID ${data.removedPlayerId}`);
        // Request updated player list
        socket.emit("getPlayerList", currentGameId);
      });

      socket.on("gameFinished", (data) => {
        log(`Game Finished: ${data.message}`);
        disableGameActions();
        document.getElementById("lobbySection").style.display = "none";
        isHost = false;
      });

      socket.on("leftGame", (data) => {
        log(`Left Game: ID ${data.gameId}`);
        disableGameActions();
        document.getElementById("lobbySection").style.display = "none";
        isHost = false;
      });

      socket.on("playerLeft", (data) => {
        log(`Player Left: ID ${data.playerInfo.playerId}`);
        // Request updated player list
        socket.emit("getPlayerList", currentGameId);
      });

      socket.on("gameRejoined", (data) => {
        log(`Rejoined Game: ID ${data.gameId}, Player ID ${data.playerName}`);
        log(`Game State: ${data.gameState}`);
        log(`Players: ${JSON.stringify(data.players)}`);
        currentGameId = data.gameId;
        currentPlayerId = data.playerId;

        // Check if player is host
        isHost = data.players.some((p) => p.id === currentPlayerId && p.isHost);

        enableGameActions();
        updatePlayerList(data.players);
        document.getElementById("lobbySection").style.display = "block";
      });

      socket.on("gameDeleted", (data) => {
        log(`Game Deleted: ${data.message}`);
        disableGameActions();
        document.getElementById("lobbySection").style.display = "none";
        isHost = false;
      });

      socket.on("error", (data) => {
        log(`Server Error: ${data.message}`);
      });

      // Enable authenticated actions
      function enableAuthenticatedActions() {
        document.getElementById("createGameBtn").disabled = !isLoggedIn;
        document.getElementById("joinGameBtn").disabled = !isLoggedIn;
        document.getElementById("rejoinGameBtn").disabled = !isLoggedIn;
      }

      // Enable the Finish Game and Leave Game buttons
      function enableGameActions() {
        document.getElementById("finishGameBtn").disabled = !isHost;
        document.getElementById("leaveGameBtn").disabled = false;
      }

      // Disable the Finish Game and Leave Game buttons
      function disableGameActions() {
        document.getElementById("finishGameBtn").disabled = true;
        document.getElementById("leaveGameBtn").disabled = true;
      }

      // Game Action Handlers
      function createGame() {
        socket.emit("newGame");
      }

      function joinGame() {
        const gameCode = document.getElementById("gameCode").value;
        if (!gameCode) {
          log("Error: Please enter a game code");
          return;
        }
        socket.emit("joinGame", gameCode);
      }

      function finishGame() {
        socket.emit("finishGame");
      }

      function leaveGame() {
        socket.emit("leaveGame");
      }

      function rejoinGame() {
        socket.emit("rejoinGame");
      }
    </script>
  </body>
</html>
